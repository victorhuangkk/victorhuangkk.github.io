---
title: "Statistical Data Analysis"
output: github_document
---

```{r setup, include=FALSE, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Bayesian Approach for Experimental Analysis
This file describes how to use Bayesian statistics to conduct A/B test. Click through rate can be modeled by Bernoulli distribution. But the click through process should be generated by binomial distribution

```{r}

library(bigrquery)
library(tidyverse)
library(ggplot2)
library(bayesAB)
library(readr)
setwd("/Users/victorhuangkk/Desktop/fabien/freshii_bayesian")


##### Experimental Group #####
menu_exp <- read_csv("menu_v2_experimental.csv")
menu_exp <- menu_exp[ which(menu_exp$Experiment.Partition.ID == 1), ]


menu_exp_df <- menu_exp %>% dplyr::select("Timestamp.Date",
                                          "Menu.Impression",
                                          "Menu.Impression.....Purchase")

# menu_exp_df <- menu_exp_df %>% 
# filter(Experiment.Partition.ID == 4)
colnames(menu_exp_df) <- c("date", "impression", "purchase")

menu_exp_df$purchase <- as.numeric(sub("%", "",
                                       menu_exp_df$purchase, fixed=TRUE))/100

menu_exp_df$impression <- as.numeric(sub(",", "", menu_exp_df$impression, fixed = TRUE))
menu_exp_df$purchase <- menu_exp_df$purchase * menu_exp_df$impression

# get exact number of people, getting rid of float number influence. 
num_purchase <- round(sum(menu_exp_df$purchase)) 
num_impression <- round(sum(menu_exp_df$impression))

# construct the vector containing success/failure 
purchase_vec <- rep.int(1, num_purchase)
non_purchase_vec <- rep.int(0, (num_impression-num_purchase))
total_vec <- c(purchase_vec, non_purchase_vec)

# shuffle the sample to make it looks like randomized sampling
total_vec <- sample(total_vec)
experimental <- total_vec


##### Control Group #####
menu_con <- read_csv("menu_v2_control.csv")
menu_con <- menu_con[ which(menu_con$Experiment.Partition.ID == 2 | menu_con$Experiment.Partition.ID == 3), ]

menu_con_df <- menu_con %>% dplyr::select("Timestamp.Date",
                                          "Menu.Impression",
                                          "Menu.Impression.....Purcharse")

#menu_con_df <- menu_con_df %>% 
#  filter(Experiment.Partition.ID == 5 | Experiment.Partition.ID == 6)

colnames(menu_con_df) <- c("date", "impression", "purchase")

menu_con_df$purchase <- as.numeric(sub("%", "",
                                       menu_con_df$purchase, fixed=TRUE))/100

menu_con_df$impression <- as.numeric(sub(",", "", 
                                         menu_con_df$impression, fixed = TRUE))

menu_con_df$purchase <- menu_con_df$purchase * menu_con_df$impression

num_purchase <- round(sum(menu_con_df$purchase))
num_impression <- round(sum(menu_con_df$impression))

purchase_vec <- rep.int(1, num_purchase)
non_purchase_vec <- rep.int(0, (num_impression-num_purchase))

total_vec <- c(purchase_vec, non_purchase_vec)

# shuffle the sample to make it looks like randomized sampling
total_vec <- sample(total_vec)
control <- total_vec
```

based on common knowladge, I chose the number to be less than 50%, around 30%. 

```{r}
test1 <- bayesTest(experimental, control, priors = c('alpha' = 1, 'beta' = 1), n_samples = 1e+05,
                   distribution = "bernoulli")
summary(test1)
plot(test1)

```


###### Control Group Internal Check ######

##### Control Group1 #####

```{r}
menu_con <- read_csv("menu_v2_control.csv")
menu_con <- menu_con[ which(menu_con$Experiment.Partition.ID == 5), ]

menu_con_df <- menu_con %>% dplyr::select("Timestamp.Date",
                                          "Menu.Impression",
                                          "Menu.Impression.....Purcharse")

colnames(menu_con_df) <- c("date", "impression", "purchase")

menu_con_df$purchase <- as.numeric(sub("%", "",
                                       menu_con_df$purchase, fixed=TRUE))/100

menu_con_df$impression <- as.numeric(sub(",", "", 
                                         menu_con_df$impression, fixed = TRUE))

menu_con_df$purchase <- menu_con_df$purchase * menu_con_df$impression

num_purchase <- round(sum(menu_con_df$purchase))
num_impression <- round(sum(menu_con_df$impression))

purchase_vec <- rep.int(1, num_purchase)
non_purchase_vec <- rep.int(0, (num_impression-num_purchase))

total_vec <- c(purchase_vec, non_purchase_vec)

# shuffle the sample to make it looks like randomized sampling
total_vec <- sample(total_vec)
control1 <- total_vec

menu_con <- read_csv("menu_v2_control.csv")
menu_con <- menu_con[ which(menu_con$Experiment.Partition.ID == 6), ]

menu_con_df <- menu_con %>% dplyr::select("Timestamp.Date",
                                          "Menu.Impression",
                                          "Menu.Impression.....Purcharse")

colnames(menu_con_df) <- c("date", "impression", "purchase")

menu_con_df$purchase <- as.numeric(sub("%", "",
                                       menu_con_df$purchase, fixed=TRUE))/100

menu_con_df$impression <- as.numeric(sub(",", "", 
                                         menu_con_df$impression, fixed = TRUE))

menu_con_df$purchase <- menu_con_df$purchase * menu_con_df$impression

num_purchase <- round(sum(menu_con_df$purchase))
num_impression <- round(sum(menu_con_df$impression))

purchase_vec <- rep.int(1, num_purchase)
non_purchase_vec <- rep.int(0, (num_impression-num_purchase))

total_vec <- c(purchase_vec, non_purchase_vec)

# shuffle the sample to make it looks like randomized sampling
total_vec <- sample(total_vec)
control2 <- total_vec


test2 <- bayesTest(experimental, control, priors = c('alpha' = 1, 'beta' = 1), n_samples = 1e+05,
                   distribution = "bernoulli")
summary(test2)
plot(test2)

```


